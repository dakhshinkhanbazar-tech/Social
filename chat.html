<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Private Chat</title>
    <style>
        body { background: #e5ddd5; font-family: sans-serif; margin: 0; padding: 10px; }
        .header { background: #075e54; color: white; padding: 12px; font-weight: bold; text-align: center; border-radius: 5px 5px 0 0; }
        .msg-box { background: white; height: 350px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; margin-bottom: 15px; border-radius: 0 0 5px 5px; }
        .sent { color: #075e54; background: #dcf8c6; padding: 8px; margin: 5px 0; border-radius: 8px; text-align: right; border: 1px solid #c7e9b4; }
        .received { color: #333; background: #fff; padding: 8px; margin: 5px 0; border-radius: 8px; border: 1px solid #ddd; text-align: left; }
        .send-btn { background: #075e54; color: white; padding: 15px; text-decoration: none; display: block; text-align: center; font-weight: bold; border-radius: 8px; font-size: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .refresh-btn { background: #555; color: white; border: none; padding: 8px; width: 100%; margin-bottom: 5px; border-radius: 5px; cursor: pointer; }
        #status { font-size: 12px; text-align: center; color: #666; }
    </style>
</head>
<body>
    <div class="header">Chatting with: <span id="fName"></span></div>

    <div class="msg-box" id="displayMsgs">Loading messages...</div>
    <div id="status"></div>

    <button class="refresh-btn" onclick="loadMessages()">üîÑ Refresh Chat</button>

    <a href="https://docs.google.com/forms/d/e/1FAIpQLSfmE76RL2xnBFpbccLuCy5_qB4IA-F7vkSGQ4Rl1byGQwDfZw/viewform" target="_blank" class="send-btn">‚ûï WRITE MESSAGE</a>

    <script>
        var params = new URLSearchParams(window.location.search);
        var me = params.get('me') || "User";
        var friend = params.get('friend') || "Friend";
        document.getElementById('fName').innerText = friend;

        // ‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ ‡¶ó‡ßÅ‡¶ó‡¶≤ ‡¶∂‡¶ø‡¶ü‡ßá‡¶∞ CSV ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï (‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶™‡ßú‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø)
        var sheetUrl = "https://docs.google.com/spreadsheets/d/1vCbeWnAt81SExCWhI8jYpS_jE4lYjKzL05jY9D3Yy-E/gviz/tq?tqx=out:csv";

        function loadMessages() {
            var status = document.getElementById('status');
            status.innerText = "Updating...";
            
            fetch(sheetUrl)
            .then(res => res.text())
            .then(data => {
                var rows = data.split("\n");
                var html = "";
                var found = false;

                for (var i = 1; i < rows.length; i++) {
                    var cols = rows[i].split(",");
                    if (cols.length >= 4) {
                        // ‡¶ï‡¶≤‡¶æ‡¶Æ ‡¶™‡¶∞‡¶ø‡¶∑‡ßç‡¶ï‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ (‡¶ï‡ßã‡¶ü‡ßá‡¶∂‡¶® ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ï ‡¶∏‡¶∞‡¶æ‡¶®‡ßã)
                        var from = cols[1].replace(/"/g, "").trim();
                        var to = cols[2].replace(/"/g, "").trim();
                        var message = cols[3].replace(/"/g, "").trim();

                        // ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶§‡ßã‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶¶‡ßÅ‡¶ú‡¶®‡ßá‡¶∞ ‡¶™‡ßç‡¶∞‡¶æ‡¶á‡¶≠‡ßá‡¶ü ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞
                        if ((from == me && to == friend) || (from == friend && to == me)) {
                            var style = (from == me) ? "sent" : "received";
                            html += "<div class='"+style+"'><b>"+from+":</b> "+message+"</div>";
                            found = true;
                        }
                    }
                }
                document.getElementById('displayMsgs').innerHTML = html || "No messages yet. Click 'Write Message' to start!";
                status.innerText = "";
                
                // ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶≤ ‡¶Ö‡¶ü‡ßã‡¶Æ‡ßá‡¶ü‡¶ø‡¶ï ‡¶®‡¶ø‡¶ö‡ßá ‡¶®‡¶æ‡¶Æ‡¶ø‡ßü‡ßá ‡¶¶‡ßá‡¶ì‡ßü‡¶æ
                var box = document.getElementById('displayMsgs');
                box.scrollTop = box.scrollHeight;
            })
            .catch(err => {
                status.innerText = "Connection error!";
            });
        }

        // ‡¶™‡ßá‡¶ú ‡¶ñ‡ßÅ‡¶≤‡¶≤‡ßá ‡¶è‡¶¨‡¶Ç ‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡ßß‡ß¶ ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶°‡ßá ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂ ‡¶π‡¶¨‡ßá
        loadMessages();
        setInterval(loadMessages, 10000);
    </script>
</body>
</html>
