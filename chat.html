<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Private Chat</title>
    <style>
        body { background: #e5ddd5; font-family: sans-serif; margin: 0; padding: 10px; }
        .header { background: #075e54; color: white; padding: 12px; font-weight: bold; text-align: center; border-radius: 5px; position: sticky; top: 0; }
        .msg-box { background: white; height: 380px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; margin: 10px 0; border-radius: 5px; display: flex; flex-direction: column; }
        .sent { background: #dcf8c6; padding: 10px; margin: 5px 0 5px auto; border-radius: 10px 10px 0 10px; width: fit-content; max-width: 85%; text-align: right; border: 1px solid #c7e9b4; box-shadow: 1px 1px 2px #ccc; }
        .received { background: #fff; padding: 10px; margin: 5px auto 5px 0; border-radius: 10px 10px 10px 0; width: fit-content; max-width: 85%; border: 1px solid #ddd; box-shadow: 1px 1px 2px #ccc; }
        .name-label { font-size: 10px; font-weight: bold; color: #075e54; display: block; margin-bottom: 3px; }
        .send-btn { background: #075e54; color: white; padding: 15px; text-decoration: none; display: block; text-align: center; font-weight: bold; border-radius: 8px; font-size: 16px; }
        .refresh-btn { background: #555; color: white; border: none; padding: 8px; width: 100%; border-radius: 5px; cursor: pointer; margin-bottom: 5px; }
    </style>
</head>
<body>
    <div class="header">Chat with: <span id="fName"></span></div>
    
    <div class="msg-box" id="displayMsgs">Connecting to sheet...</div>
    
    <button class="refresh-btn" onclick="loadMessages()">üîÑ Refresh Messages</button>

    <a href="https://docs.google.com/forms/d/e/1FAIpQLSfmE76RL2xnBFpbccLuCy5_qB4IA-F7vkSGQ4Rl1byGQwDfZw/viewform" target="_blank" class="send-btn">‚ûï WRITE MESSAGE</a>

    <script>
        // URL ‡¶•‡ßá‡¶ï‡ßá ‡¶®‡¶æ‡¶Æ ‡¶∏‡¶Ç‡¶ó‡ßç‡¶∞‡¶π
        var params = new URLSearchParams(window.location.search);
        var me = (params.get('me') || "").trim().toLowerCase(); 
        var friend = (params.get('friend') || "").trim().toLowerCase();
        var friendDisplay = params.get('friend') || "Friend";
        document.getElementById('fName').innerText = friendDisplay;

        // ‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ ‡¶∂‡¶ø‡¶ü‡ßá‡¶∞ ‡¶∏‡¶†‡¶ø‡¶ï CSV ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï
        var sheetUrl = "https://docs.google.com/spreadsheets/d/1vCbeWnAt81SExCWhI8jYpS_jE4lYjKzL05jY9D3Yy-E/gviz/tq?tqx=out:csv";

        function loadMessages() {
            var box = document.getElementById('displayMsgs');
            
            fetch(sheetUrl)
            .then(res => res.text())
            .then(data => {
                var rows = data.split("\n");
                var html = "";
                var foundAny = false;

                // row 1 ‡¶•‡ßá‡¶ï‡ßá ‡¶∂‡ßÅ‡¶∞‡ßÅ (‡¶ü‡¶æ‡¶á‡¶Æ > ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú > ‡¶®‡¶æ‡¶Æ ‡¶∏‡¶ø‡¶∞‡¶ø‡ßü‡¶æ‡¶≤ ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ)
                for (var i = 1; i < rows.length; i++) {
                    // CSV ‡¶ï‡¶≤‡¶æ‡¶Æ‡¶ó‡ßÅ‡¶≤‡ßã‡¶ï‡ßá ‡¶ï‡¶Æ‡¶æ ‡¶¶‡¶ø‡ßü‡ßá ‡¶≠‡¶æ‡¶ó ‡¶ï‡¶∞‡¶æ
                    var cols = rows[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                    
                    if (cols.length >= 3) {
                        var message = cols[1].replace(/"/g, "").trim(); 
                        var senderName = cols[2].replace(/"/g, "").trim(); 
                        var senderLow = senderName.toLowerCase();

                        // ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶è‡¶¨‡¶Ç ‡¶¨‡¶®‡ßç‡¶ß‡ßÅ‡¶∞ ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú‡¶ó‡ßÅ‡¶≤‡ßã ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨‡ßá
                        if (senderLow === me || senderLow === friend) {
                            var style = (senderLow === me) ? "sent" : "received";
                            html += "<div class='"+style+"'><span class='name-label'>"+senderName+"</span>"+message+"</div>";
                            foundAny = true;
                        }
                    }
                }
                
                box.innerHTML = foundAny ? html : "<p style='text-align:center; color:#999;'>No private messages yet with " + friendDisplay + "</p>";
                box.scrollTop = box.scrollHeight; // ‡¶è‡¶ï‡¶¶‡¶Æ ‡¶®‡¶ø‡¶ö‡ßá ‡¶®‡¶ø‡ßü‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá
            })
            .catch(err => {
                box.innerHTML = "<p style='color:red; text-align:center;'>Error: ‡¶∂‡¶ø‡¶ü ‡¶•‡ßá‡¶ï‡ßá ‡¶°‡¶æ‡¶ü‡¶æ ‡¶Ü‡¶∏‡¶õ‡ßá ‡¶®‡¶æ‡•§ ‡¶¶‡ßü‡¶æ ‡¶ï‡¶∞‡ßá ‡¶∂‡¶ø‡¶ü‡¶ü‡¶ø Share > Anyone with link > Viewer ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p>";
            });
        }

        // ‡¶™‡ßá‡¶ú ‡¶ñ‡ßÅ‡¶≤‡¶≤‡ßá‡¶á ‡¶≤‡ßã‡¶° ‡¶π‡¶¨‡ßá
        loadMessages();
        // ‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡ßÆ ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶°‡ßá ‡¶Ö‡¶ü‡ßã ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡¶¨‡ßá
        setInterval(loadMessages, 8000);
    </script>
</body>
</html>
