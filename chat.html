<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Private Chat</title>
    <style>
        body { background: #e5ddd5; font-family: sans-serif; margin: 0; padding: 10px; }
        .header { background: #075e54; color: white; padding: 12px; font-weight: bold; text-align: center; border-radius: 5px; position: sticky; top: 0; z-index: 100; }
        .msg-box { background: white; height: 380px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; margin: 10px 0; border-radius: 5px; display: flex; flex-direction: column; }
        .sent { background: #dcf8c6; padding: 10px; margin: 5px 0 5px auto; border-radius: 10px 10px 0 10px; width: fit-content; max-width: 85%; text-align: right; border: 1px solid #c7e9b4; box-shadow: 1px 1px 2px #ccc; }
        .received { background: #fff; padding: 10px; margin: 5px auto 5px 0; border-radius: 10px 10px 10px 0; width: fit-content; max-width: 85%; border: 1px solid #ddd; box-shadow: 1px 1px 2px #ccc; }
        .name-label { font-size: 10px; font-weight: bold; color: #075e54; display: block; margin-bottom: 3px; }
        .send-btn { background: #075e54; color: white; padding: 15px; text-decoration: none; display: block; text-align: center; font-weight: bold; border-radius: 8px; font-size: 16px; margin-top: 5px; }
        .refresh-btn { background: #555; color: white; border: none; padding: 10px; width: 100%; border-radius: 5px; cursor: pointer; font-weight: bold; }
        #debug { font-size: 10px; color: #777; text-align: center; margin-top: 5px; }
    </style>
</head>
<body>
    <div class="header">Chat with: <span id="fName"></span></div>
    
    <div class="msg-box" id="displayMsgs">Connecting to server...</div>
    
    <button class="refresh-btn" onclick="loadMessages()">üîÑ Refresh Messages</button>

    <a href="https://docs.google.com/forms/d/e/1FAIpQLSfmE76RL2xnBFpbccLuCy5_qB4IA-F7vkSGQ4Rl1byGQwDfZw/viewform" target="_blank" class="send-btn">‚ûï WRITE MESSAGE</a>
    
    <div id="debug"></div>

    <script>
        var params = new URLSearchParams(window.location.search);
        var meRaw = params.get('me') || "";
        var friendRaw = params.get('friend') || "";
        
        // ‡¶®‡¶æ‡¶Æ‡¶ó‡ßÅ‡¶≤‡ßã ‡¶™‡¶∞‡¶ø‡¶∑‡ßç‡¶ï‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ (‡¶¨‡ßú ‡¶π‡¶æ‡¶§/‡¶õ‡ßã‡¶ü ‡¶π‡¶æ‡¶§ ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶¶‡ßÇ‡¶∞ ‡¶ï‡¶∞‡¶§‡ßá)
        var me = meRaw.trim().toLowerCase();
        var friend = friendRaw.trim().toLowerCase();
        
        document.getElementById('fName').innerText = friendRaw;

        // ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∂‡¶ø‡¶ü‡ßá‡¶∞ ‡¶∏‡¶†‡¶ø‡¶ï CSV ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï
        var sheetUrl = "https://docs.google.com/spreadsheets/d/1vCbeWnAt81SExCWhI8jYpS_jE4lYjKzL05jY9D3Yy-E/gviz/tq?tqx=out:csv";

        function loadMessages() {
            var box = document.getElementById('displayMsgs');
            var debug = document.getElementById('debug');
            
            fetch(sheetUrl)
            .then(res => res.text())
            .then(data => {
                var rows = data.split("\n");
                var html = "";
                var foundCount = 0;

                // row 1 ‡¶•‡ßá‡¶ï‡ßá ‡¶∂‡ßÅ‡¶∞‡ßÅ (‡¶ü‡¶æ‡¶á‡¶Æ > ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú > ‡¶®‡¶æ‡¶Æ ‡¶∏‡¶ø‡¶∞‡¶ø‡ßü‡¶æ‡¶≤ ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ)
                for (var i = 1; i < rows.length; i++) {
                    var cols = rows[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                    
                    if (cols.length >= 3) {
                        var message = cols[1].replace(/"/g, "").trim();      
                        var senderFromSheet = cols[2].replace(/"/g, "").trim() || "Unknown"; // ‡¶®‡¶æ‡¶Æ ‡¶ñ‡¶æ‡¶≤‡¶ø ‡¶•‡¶æ‡¶ï‡¶≤‡ßá Unknown ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨‡ßá
                        var senderLow = senderFromSheet.toLowerCase();

                        // ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞: ‡¶Ø‡¶¶‡¶ø ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú‡¶ü‡¶ø ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶π‡ßü ‡¶Ö‡¶•‡¶¨‡¶æ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡¶®‡ßç‡¶ß‡ßÅ‡¶∞ ‡¶π‡ßü
                        if (senderLow === me || senderLow === friend) {
                            var style = (senderLow === me) ? "sent" : "received";
                            html += "<div class='"+style+"'><span class='name-label'>"+senderFromSheet+"</span>"+message+"</div>";
                            foundCount++;
                        }
                    }
                }
                
                if (foundCount > 0) {
                    box.innerHTML = html;
                } else {
                    box.innerHTML = "<p style='text-align:center; color:#999; padding:20px;'>No private messages yet.<br><small>Make sure you type your name as <b>" + meRaw + "</b> in the form.</small></p>";
                }
                
                box.scrollTop = box.scrollHeight;
                debug.innerText = "Last Updated: " + new Date().toLocaleTimeString();
            })
            .catch(err => {
                box.innerHTML = "<p style='color:red; text-align:center;'>Error! Please check if the Google Sheet is 'Public' (Anyone with link can view).</p>";
            });
        }

        loadMessages();
        setInterval(loadMessages, 8000); 
    </script>
</body>
</html>
