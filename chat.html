<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Room</title>
    <style>
        body { background: #e5ddd5; font-family: sans-serif; margin: 0; padding: 10px; }
        .header { background: #075e54; color: white; padding: 10px; font-weight: bold; text-align: center; }
        .msg-container { background: white; border: 1px solid #ccc; height: 250px; overflow-y: scroll; margin: 10px 0; padding: 10px; font-size: 14px; }
        .sent { color: blue; margin-bottom: 5px; text-align: right; }
        .received { color: green; margin-bottom: 5px; text-align: left; }
        textarea { width: 90%; padding: 5px; }
        .btn { background: #075e54; color: white; border: none; padding: 8px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>
    <div class="header">Chat with: <span id="fName"></span></div>

    <div class="msg-container" id="displayMsgs">Loading messages...</div>
    
    <button class="btn" onclick="loadMessages()">üîÑ Refresh Messages</button>
    <hr>

    <form action="https://script.google.com/macros/s/AKfycbzCA5DnBiCYI-slVMgd2Lv2PNYytk0PWSHNfEl8D003LNKVzLLPazCEMBQhayCUN-g8/exec" method="get">
        <input type="hidden" name="action" value="send">
        <input type="hidden" name="user" id="myInputName">
        <input type="hidden" name="friend" id="friendInputName">
        <textarea name="msg" rows="3" placeholder="Type here..." required></textarea><br>
        <input type="submit" class="btn" value="SEND">
    </form>

    <script>
        var params = new URLSearchParams(window.location.search);
        var me = params.get('me');
        var friend = params.get('friend');
        
        document.getElementById('fName').innerText = friend;
        document.getElementById('myInputName').value = me;
        document.getElementById('friendInputName').value = friend;

        // ‡¶ó‡ßÅ‡¶ó‡¶≤ ‡¶∂‡¶ø‡¶ü‡ßá‡¶∞ CSV ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï (‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ ‡¶∂‡¶ø‡¶ü ‡¶Ü‡¶á‡¶°‡¶ø ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá)
        var sheetUrl = "https://docs.google.com/spreadsheets/d/1vCbeWnAt81SExCWhI8jYpS_jE4lYjKzL05jY9D3Yy-E/gviz/tq?tqx=out:csv";

        function loadMessages() {
            fetch(sheetUrl)
            .then(res => res.text())
            .then(data => {
                var rows = data.split("\n");
                var html = "";
                for (var i = 1; i < rows.length; i++) {
                    var cols = rows[i].split(",");
                    if (cols.length >= 4) {
                        var from = cols[1].replace(/"/g, "").trim();
                        var to = cols[2].replace(/"/g, "").trim();
                        var message = cols[3].replace(/"/g, "").trim();

                        // ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶Ü‡¶∞ ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶¨‡¶®‡ßç‡¶ß‡ßÅ‡¶∞ ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú‡¶ó‡ßÅ‡¶≤‡ßã ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨‡ßá
                        if ((from == me && to == friend) || (from == friend && to == me)) {
                            var style = (from == me) ? "sent" : "received";
                            html += "<div class='"+style+"'><b>"+from+":</b> "+message+"</div>";
                        }
                    }
                }
                document.getElementById('displayMsgs').innerHTML = html || "No messages yet.";
            });
        }

        // ‡¶™‡ßá‡¶ú ‡¶≤‡ßã‡¶° ‡¶π‡¶ì‡ßü‡¶æ‡¶∞ ‡¶∏‡¶Æ‡ßü ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨‡ßá
        loadMessages();
    </script>
</body>
</html>
