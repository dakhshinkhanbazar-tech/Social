<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Private Chat</title>
    <style>
        body { background: #e5ddd5; font-family: sans-serif; margin: 0; padding: 10px; }
        .header { background: #075e54; color: white; padding: 12px; font-weight: bold; text-align: center; border-radius: 5px; position: sticky; top: 0; z-index: 100; }
        .msg-box { background: white; height: 380px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; margin: 10px 0; border-radius: 5px; display: flex; flex-direction: column; }
        .sent { background: #dcf8c6; padding: 10px; margin: 5px 0 5px auto; border-radius: 10px 10px 0 10px; width: fit-content; max-width: 85%; text-align: right; border: 1px solid #c7e9b4; box-shadow: 1px 1px 2px #ccc; }
        .received { background: #fff; padding: 10px; margin: 5px auto 5px 0; border-radius: 10px 10px 10px 0; width: fit-content; max-width: 85%; border: 1px solid #ddd; box-shadow: 1px 1px 2px #ccc; }
        .name-label { font-size: 10px; font-weight: bold; color: #075e54; display: block; margin-bottom: 3px; }
        .send-btn { background: #075e54; color: white; padding: 15px; text-decoration: none; display: block; text-align: center; font-weight: bold; border-radius: 8px; font-size: 16px; margin-top: 5px; }
        .refresh-btn { background: #555; color: white; border: none; padding: 10px; width: 100%; border-radius: 5px; cursor: pointer; font-weight: bold; }
        #debug { font-size: 10px; color: #777; text-align: center; margin-top: 5px; }
    </style>
</head>
<body>
    <div class="header">Chat with: <span id="fName"></span></div>
    <div class="msg-box" id="displayMsgs">Connecting...</div>
    <button class="refresh-btn" onclick="loadMessages()">ðŸ”„ Refresh Messages</button>
    <a href="https://docs.google.com/forms/d/e/1FAIpQLSfmE76RL2xnBFpbccLuCy5_qB4IA-F7vkSGQ4Rl1byGQwDfZw/viewform" target="_blank" class="send-btn">âž• WRITE MESSAGE</a>
    <div id="debug"></div>

    <script>
        var params = new URLSearchParams(window.location.search);
        var me = (params.get('me') || "").trim().toLowerCase(); 
        var friend = (params.get('friend') || "").trim().toLowerCase();
        document.getElementById('fName').innerText = params.get('friend') || "Friend";

        var sheetUrl = "https://docs.google.com/spreadsheets/d/1vCbeWnAt81SExCWhI8jYpS_jE4lYjKzL05jY9D3Yy-E/gviz/tq?tqx=out:csv";

        function loadMessages() {
            var box = document.getElementById('displayMsgs');
            fetch(sheetUrl)
            .then(res => res.text())
            .then(data => {
                var rows = data.split("\n");
                var html = "";
                var foundCount = 0;

                for (var i = 1; i < rows.length; i++) {
                    // CSV à¦•à¦²à¦¾à¦®à¦—à§à¦²à§‹à¦•à§‡ à¦•à¦®à¦¾ à¦¦à¦¿à§Ÿà§‡ à¦­à¦¾à¦— à¦•à¦°à¦¾à¦° à¦‰à¦¨à§à¦¨à¦¤ à¦ªà¦¦à§à¦§à¦¤à¦¿
                    var cols = rows[i].match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
                    if (cols && cols.length >= 3) {
                        var message = cols[1].replace(/"/g, "").trim(); 
                        var senderName = cols[2].replace(/"/g, "").trim(); 
                        var senderLow = senderName.toLowerCase();

                        if (senderLow === me || senderLow === friend) {
                            var style = (senderLow === me) ? "sent" : "received";
                            html += "<div class='"+style+"'><span class='name-label'>"+senderName+"</span>"+message+"</div>";
                            foundCount++;
                        }
                    }
                }
                box.innerHTML = foundCount > 0 ? html : "<p style='text-align:center; color:#999;'>No messages found between " + me + " and " + friend + "</p>";
                box.scrollTop = box.scrollHeight;
                document.getElementById('debug').innerText = "Last Sync: " + new Date().toLocaleTimeString();
            })
            .catch(err => { box.innerHTML = "Error loading data."; });
        }
        loadMessages();
        setInterval(loadMessages, 8000);
    </script>
</body>
</html>
