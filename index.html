<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Private Chat - Button Phone</title>
    <style>
        body { font-family: monospace; background: #000; color: #0f0; padding: 5px; }
        .card { border: 1px solid #0f0; padding: 5px; margin-bottom: 10px; }
        input { background: #222; color: #0f0; border: 1px solid #0f0; width: 90%; margin-bottom: 5px; padding: 3px; }
        button { background: #0f0; color: #000; border: none; padding: 5px; cursor: pointer; font-weight: bold; }
        #chat-window { height: 180px; overflow-y: scroll; border: 1px dashed #0f0; margin-bottom: 5px; padding: 3px; }
        .msg { margin-bottom: 4px; font-size: 13px; border-bottom: 1px solid #222; }
    </style>
</head>
<body>

<div id="login-ui" class="card">
    <b>[ লগইন ]</b><br>
    নাম: <input type="text" id="u_name" placeholder="আপনার নাম"><br>
    পিন: <input type="number" id="u_pin" placeholder="৪ সংখ্যার পিন"><br>
    <button onclick="login()">প্রবেশ করুন</button>
</div>

<div id="dash-ui" style="display:none;" class="card">
    <b>স্বাগতম: <span id="my-name"></span></b><hr>
    খুঁজুন: <input type="text" id="s_box" placeholder="বন্ধুর নাম লিখুন">
    <button onclick="search()">সার্চ</button>
    <div id="res" style="margin-top:5px;"></div>
</div>

<div id="chat-ui" style="display:none;" class="card">
    <button onclick="back()">← ফিরে যান</button><br>
    <b>কথা হচ্ছে: <span id="chat-with"></span></b>
    <div id="chat-window"></div>
    <input type="text" id="msg" placeholder="মেসেজ লিখুন">
    <button onclick="send()">পাঠান</button>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
    // তোমার আগের ফায়ারবেস কনফিগারেশনটি এখানে বসাও
    var config = {
      apiKey: "AIzaSyCvQ4ti0RjqmTCUZ5g5dXua_vjGNqqlyeg",
      databaseURL: "https://social-794e8-default-rtdb.firebaseio.com",
      projectId: "social-794e8"
    };
    firebase.initializeApp(config);
    var db = firebase.database();
    var SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzCA5DnBiCYI-slVMgd2Lv2PNYytk0PWSHNfEl8D003LNKVzLLPazCEMBQhayCUN-g8/exec";

    var myName = "";
    var chatID = "";

    function login() {
        var n = document.getElementById('u_name').value;
        var p = document.getElementById('u_pin').value;
        // অ্যাপ স্ক্রিপ্ট থেকে লগইন চেক
        var url = SCRIPT_URL + "?action=login&user=" + n + "&pin=" + p;
        var x = new XMLHttpRequest();
        x.open("GET", url, true);
        x.onreadystatechange = function() {
            if (x.readyState == 4 && x.status == 200) {
                var d = JSON.parse(x.responseText);
                if(d.status == "success") {
                    myName = d.username;
                    document.getElementById('login-ui').style.display = 'none';
                    document.getElementById('dash-ui').style.display = 'block';
                    document.getElementById('my-name').innerText = myName;
                } else { alert("ভুল তথ্য!"); }
            }
        };
        x.send();
    }

    function search() {
        var q = document.getElementById('s_box').value;
        var url = SCRIPT_URL + "?action=search";
        var x = new XMLHttpRequest();
        x.open("GET", url, true);
        x.onreadystatechange = function() {
            if (x.readyState == 4 && x.status == 200) {
                var users = JSON.parse(x.responseText);
                var h = "";
                for(var i=0; i<users.length; i++) {
                    if(users[i].toLowerCase().indexOf(q.toLowerCase()) > -1 && users[i] != myName) {
                        h += '<div onclick="startChat(\''+users[i]+'\')">>> '+users[i]+' [চ্যাট]</div>';
                    }
                }
                document.getElementById('res').innerHTML = h || "পাওয়া যায়নি!";
            }
        };
        x.send();
    }

    function startChat(friend) {
        document.getElementById('dash-ui').style.display = 'none';
        document.getElementById('chat-ui').style.display = 'block';
        document.getElementById('chat-with').innerText = friend;
        // প্রাইভেট আইডি তৈরি (A_B ফরম্যাটে)
        var pair = [myName, friend].sort();
        chatID = pair[0] + "_" + pair[1];
        
        db.ref("p_chats/" + chatID).limitToLast(10).on("value", function(s) {
            var w = document.getElementById('chat-window');
            w.innerHTML = "";
            s.forEach(function(c) {
                var m = c.val();
                w.innerHTML += '<div class="msg"><b>' + m.s + ':</b> ' + m.t + '</div>';
            });
            w.scrollTop = w.scrollHeight;
        });
    }

    function send() {
        var t = document.getElementById('msg').value;
        if(!t) return;
        db.ref("p_chats/" + chatID).push({ s: myName, t: t });
        document.getElementById('msg').value = "";
    }

    function back() {
        document.getElementById('chat-ui').style.display = 'none';
        document.getElementById('dash-ui').style.display = 'block';
        db.ref("p_chats/" + chatID).off();
    }
</script>
</body>
</html>
