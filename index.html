<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat App - Button Phone</title>
    <style>
        body { font-family: sans-serif; background: #e5ddd5; margin: 0; padding: 10px; }
        .box { background: white; padding: 10px; border: 1px solid #ccc; margin-bottom: 10px; border-radius: 5px; }
        input { width: 85%; padding: 8px; margin: 5px 0; border: 1px solid #ddd; }
        button { background: #075e54; color: white; border: none; padding: 8px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 5px;}
        #chat-window { height: 250px; overflow-y: scroll; border: 1px solid #eee; padding: 5px; background: #f9f9f9; }
        .msg { margin: 5px 0; padding: 5px 8px; border-radius: 5px; font-size: 14px; max-width: 80%; }
        .sent { background: #dcf8c6; margin-left: auto; text-align: right; }
        .received { background: #fff; text-align: left; border: 1px solid #ddd; }
        .user-link { display: block; padding: 10px; border-bottom: 1px solid #eee; color: #075e54; text-decoration: none; font-weight: bold; }
    </style>
</head>
<body>

<div id="login-ui" class="box">
    <h3>‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
    <input type="text" id="user-name" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ">
    <input type="number" id="user-pin" placeholder="‡ß™ ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ‡¶∞ ‡¶™‡¶ø‡¶®">
    <button onclick="doLogin()">‡¶™‡ßç‡¶∞‡¶¨‡ßá‡¶∂ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
</div>

<div id="dash-ui" style="display:none;" class="box">
    <b>‡¶∏‡ßç‡¶¨‡¶æ‡¶ó‡¶§‡¶Æ, <span id="display-name"></span></b> | <button onclick="location.reload()" style="width:auto; padding:3px; background:red;">‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü</button>
    <hr>
    <input type="text" id="search-box" placeholder="‡¶ï‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡¶õ‡ßá‡¶®?">
    <button onclick="searchUser()">‡¶∏‡¶æ‡¶∞‡ßç‡¶ö</button>
    <div id="results" style="margin-top:10px;"></div>
</div>

<div id="chat-ui" style="display:none;" class="box">
    <button onclick="backToDash()" style="background:#555; width:auto;">‚Üê ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡ßá ‡¶Ø‡¶æ‡¶®</button>
    <h4 id="chat-with">‡¶¨‡¶®‡ßç‡¶ß‡ßÅ</h4>
    <div id="chat-window"></div>
    <input type="text" id="msg-text" placeholder="‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®...">
    <button onclick="sendMsg()">‡¶™‡¶æ‡¶†‡¶æ‡¶®</button>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
    // ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶®
    const firebaseConfig = {
      apiKey: "AIzaSyCvQ4ti0RjqmTCUZ5g5dXua_vjGNqqlyeg",
      authDomain: "social-794e8.firebaseapp.com",
      databaseURL: "https://social-794e8-default-rtdb.firebaseio.com",
      projectId: "social-794e8",
      storageBucket: "social-794e8.firebasestorage.app",
      messagingSenderId: "404116095706",
      appId: "1:404116095706:web:9c8866965fe35dcae49be3"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzCA5DnBiCYI-slVMgd2Lv2PNYytk0PWSHNfEl8D003LNKVzLLPazCEMBQhayCUN-g8/exec";

    let myName = "";
    let activeChatId = "";

    function doLogin() {
        let name = document.getElementById('user-name').value.trim();
        let pin = document.getElementById('user-pin').value;
        
        fetch(`${SCRIPT_URL}?action=login&user=${name}&pin=${pin}`)
        .then(res => res.json())
        .then(data => {
            if(data.status === "success") {
                myName = data.username;
                document.getElementById('login-ui').style.display = 'none';
                document.getElementById('dash-ui').style.display = 'block';
                document.getElementById('display-name').innerText = myName;
            } else { alert("‡¶≠‡ßÅ‡¶≤ ‡¶®‡¶æ‡¶Æ ‡¶¨‡¶æ ‡¶™‡¶ø‡¶®!"); }
        }).catch(err => alert("‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞ ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ! ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§"));
    }

    function searchUser() {
        let q = document.getElementById('search-box').value.toLowerCase();
        fetch(`${SCRIPT_URL}?action=search`)
        .then(res => res.json())
        .then(users => {
            let html = "";
            users.forEach(u => {
                if(u.toLowerCase().includes(q) && u !== myName) {
                    html += `<a href="#" class="user-link" onclick="startChat('${u}')">üí¨ ${u}-‡¶è‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶ï‡¶•‡¶æ ‡¶¨‡¶≤‡ßÅ‡¶®</a>`;
                }
            });
            document.getElementById('results').innerHTML = html || "‡¶ï‡¶æ‡¶â‡¶ï‡ßá ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø!";
        });
    }

    function startChat(friend) {
        document.getElementById('dash-ui').style.display = 'none';
        document.getElementById('chat-ui').style.display = 'block';
        document.getElementById('chat-with').innerText = friend;
        activeChatId = [myName, friend].sort().join("_");
        
        db.ref("private_chats/" + activeChatId).on("value", snap => {
            let win = document.getElementById('chat-window');
            win.innerHTML = "";
            snap.forEach(child => {
                let m = child.val();
                let cls = m.sender === myName ? "sent" : "received";
                win.innerHTML += `<div class="msg ${cls}"><b>${m.sender}:</b> ${m.text}</div>`;
            });
            win.scrollTop = win.scrollHeight;
        });
    }

    function sendMsg() {
        let txt = document.getElementById('msg-text').value;
        if(!txt) return;
        db.ref("private_chats/" + activeChatId).push({ sender: myName, text: txt });
        document.getElementById('msg-text').value = "";
    }

    function backToDash() {
        document.getElementById('chat-ui').style.display = 'none';
        document.getElementById('dash-ui').style.display = 'block';
        db.ref("private_chats/" + activeChatId).off();
    }
</script>
</body>
</html>
